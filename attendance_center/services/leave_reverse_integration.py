# ================================================================
# ğŸ“˜ LeaveAttendanceIntegrator â€” Primey HR Cloud V2 Ultra Pro
# ================================================================
# Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù†:
# 1) ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© (Apply)
# 2) Ø¥Ø²Ø§Ù„Ø© Ø£Ø«Ø± Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¶/Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Rollback)
# 3) Ø¯Ø¹Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø²Ø¦ÙŠ Ù„Ùˆ ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§
# 4) Ø­Ù…Ø§ÙŠØ© Ø³Ø¬Ù„Ø§Øª Biotime Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
# 5) Ù…Ù†Ø¹ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ø¨ÙŠÙ† Leave â†” Attendance Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
# 6) Ø¯Ø¹Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©
# ================================================================

from datetime import timedelta
from attendance_center.models import AttendanceRecord


class LeaveAttendanceIntegrator:

    def __init__(self, leave_request):
        self.leave = leave_request
        self.employee = leave_request.employee
        self.company = leave_request.company

    # ------------------------------------------------------------
    # ğŸŸ© Helper â€” Ù†Ø·Ø§Ù‚ Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©
    # ------------------------------------------------------------
    def _each_day(self):
        cur = self.leave.start_date
        while cur <= self.leave.end_date:
            yield cur
            cur += timedelta(days=1)

    # ------------------------------------------------------------
    # ğŸŸ¦ 1) Apply Leave â†’ Attendance (V2)
    # ------------------------------------------------------------
    def apply_leave(self):
        """
        - ÙŠØ«Ø¨Øª Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© ÙƒØºÙŠØ§Ø¨ Ù…ØµØ±Ø­ Ø¨Ù‡
        - ÙŠØ¹Ø¯Ù„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        - ÙŠÙ…Ù†Ø¹ Biotime Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§
        """

        for day in self._each_day():

            record = AttendanceRecord.objects.filter(
                employee=self.employee,
                date=day
            ).first()

            # --------------------------------------------------------
            # ğŸ”µ Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…ØµØ¯Ø±Ù‡ Biotime
            # --------------------------------------------------------
            if record and record.synced_from_biotime:
                record.status = "leave"
                record.is_leave = True
                record.is_locked = True          # ğŸ†• ÙŠÙ…Ù†Ø¹ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ
                record.save()
                continue

            # --------------------------------------------------------
            # ğŸŸ¡ Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ†Ù‡ Ù„ÙŠØ³ Ù…Ù† Biotime
            # --------------------------------------------------------
            if record and not record.synced_from_biotime:
                record.status = "leave"
                record.is_leave = True
                record.is_locked = True          # ğŸ†• Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
                record.synced_from_biotime = False
                record.save()
                continue

            # --------------------------------------------------------
            # ğŸŸ¢ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ (Ø§Ù„ÙŠÙˆÙ… Ù„Ù… ÙŠØ³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§)
            # --------------------------------------------------------
            AttendanceRecord.objects.create(
                company=self.company,
                employee=self.employee,
                date=day,
                status="leave",
                is_leave=True,
                is_locked=True,            # ğŸ†• Ø³Ø¬Ù„ Ù…Ø­Ù…ÙŠ Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                synced_from_biotime=False,
                check_in=None,
                check_out=None,
                notes="Generated by LeaveApprovalEngine"
            )

    # ------------------------------------------------------------
    # ğŸŸ¥ 2) Rollback Leave â†’ Attendance (V2)
    # ------------------------------------------------------------
    def rollback_leave(self):
        """
        - ÙŠØ­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©
        - ÙŠØ¹ÙŠØ¯ Ø³Ø¬Ù„Ø§Øª Biotime Ù„Ø·Ø¨ÙŠØ¹ØªÙ‡Ø§ Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù
        - ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø­Ø±Ùƒ Attendance
        """

        for day in self._each_day():

            record = AttendanceRecord.objects.filter(
                employee=self.employee,
                date=day
            ).first()

            if not record:
                continue

            # --------------------------------------------------------
            # ğŸ”µ Ø³Ø¬Ù„ Ù‚Ø§Ø¯Ù… Ù…Ù† Biotime â†’ Ù„Ø§ ÙŠÙØ­Ø°Ù
            # --------------------------------------------------------
            if record.synced_from_biotime:
                record.is_leave = False
                record.is_locked = False     # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙ†ÙŠÙ
                record.status = record.classify_status()
                record.save()
                continue

            # --------------------------------------------------------
            # ğŸŸ¡ Ø³Ø¬Ù„ Ù…ØµÙ†ÙˆØ¹ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© ÙÙ‚Ø· â†’ ÙŠØªÙ… Ø­Ø°ÙÙ‡
            # --------------------------------------------------------
            if record.is_leave and not record.synced_from_biotime:
                record.delete()
                continue

            # --------------------------------------------------------
            # ğŸŸ  Ø³Ø¬Ù„ Ù…Ø¹Ø¯Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ â†’ Ù†Ø¹ÙŠØ¯Ù‡ Ù„Ø·Ø¨ÙŠØ¹ØªÙ‡
            # --------------------------------------------------------
            if record.is_locked:
                record.is_leave = False
                record.is_locked = False
                record.status = record.classify_status()
                record.save()
